<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貨架結構計算模擬器 V6.0</title>
    <style>
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background-color: #f8fafc; color: #334155; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; display: flex; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-radius: 12px; overflow: hidden; min-height: 900px; }
        
        /* 左側參數區 */
        .sidebar { flex: 0 0 380px; background: #fff; padding: 25px; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow-y: auto; height: 100vh; max-height: 950px; box-sizing: border-box; }
        
        h2 { margin: 0 0 15px 0; color: #1e293b; font-size: 18px; border-left: 4px solid #3b82f6; padding-left: 10px; font-weight: 700; }
        .section { margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid #f1f5f9; }
        
        label { display: block; font-weight: 600; margin-bottom: 6px; color: #64748b; font-size: 13px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-col { flex: 1; }
        
        input, select { width: 100%; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; box-sizing: border-box; transition: 0.2s; background: #fff; color: #334155; }
        input:focus, select:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        input[readonly] { background-color: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: default; }
        
        /* I值灰色小字樣式 */
        .i-value-wrapper { display: flex; justify-content: flex-end; align-items: center; margin-top: 5px; }
        .i-value-label { font-size: 12px; color: #cbd5e1; margin-right: 5px; }
        .i-value-text { font-size: 12px; color: #94a3b8; border: none; background: transparent; text-align: right; width: 80px; padding: 0; pointer-events: none; }

        .note { font-size: 12px; color: #94a3b8; margin-top: -5px; margin-bottom: 10px; line-height: 1.4; }

        button { width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        button:hover { background: #2563eb; }

        /* 結果儀表板 */
        .results-panel { margin-top: 20px; }
        .res-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #cbd5e0; }
        .res-card.safe { border-left-color: #22c55e; background: #f0fdf4; }
        .res-card.danger { border-left-color: #ef4444; background: #fef2f2; }
        .res-card.warning { border-left-color: #f59e0b; background: #fffbeb; }
        
        .res-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .res-title { font-weight: 700; color: #475569; font-size: 13px; }
        .res-status { font-weight: 700; font-size: 11px; padding: 2px 8px; border-radius: 10px; }
        .res-main { font-size: 22px; font-weight: 800; color: #0f172a; }
        .res-sub { font-size: 12px; color: #64748b; }

        /* 右側視覺區 */
        .visualizer { flex: 1; background: #1e293b; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        canvas { background: #fff; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 90vh; }
        .legend { margin-top: 15px; color: #cbd5e0; font-size: 12px; display: flex; gap: 15px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="section">
            <h2>1. 貨架整體配置</h2>
            <div class="input-row">
                <div class="input-col">
                    <label>立柱總高 (m)</label>
                    <input type="number" id="h-total" value="6.0" step="0.5" onchange="autoUpdateSpan()">
                </div>
                <div class="input-col">
                    <label>層數</label>
                    <input type="number" id="levels" value="3" onchange="autoUpdateSpan()">
                </div>
            </div>

            <label style="color:#d97706;">最大層距 (m) <span style="font-weight:normal; font-size:0.8em;">(無支撐長度)</span></label>
            <input type="number" id="max-span" value="2.0" step="0.1" onchange="calc()">

            <div style="margin-top:12px;">
                <label>單層荷重 (kg)</label>
                <input type="number" id="load-layer" value="1000" onchange="calc()">
                <div class="note">系統自動除以2計算單支橫樑</div>
            </div>
        </div>

        <div class="section" style="border-left: 4px solid #8b5cf6;">
            <h2>2. 橫樑規格</h2>
            
            <label>橫樑類型</label>
            <select id="beam-type" onchange="updateBeamPreset()">
                <option value="C">C樑</option>
                <option value="B">B樑</option>
                <option value="G">G樑</option>
            </select>

            <div class="input-row" style="margin-top:10px;">
                <div class="input-col">
                    <label>長度 L (mm)</label>
                    <input type="number" id="beam-len" value="2500" onchange="calc()">
                </div>
                <div class="input-col">
                    <label>折高 H (mm)</label>
                    <input type="number" id="beam-h" value="100" onchange="reCalcI()">
                </div>
            </div>

            <div class="input-row">
                <div class="input-col">
                    <label>寬度 W (mm)</label>
                    <input type="number" id="beam-w" value="50" readonly>
                </div>
                <div class="input-col">
                    <label>厚度 t (mm)</label>
                    <input type="number" id="beam-t" value="1.5" step="0.1" onchange="reCalcI()">
                </div>
            </div>

            <div class="i-value-wrapper">
                <span class="i-value-label">2次斷面慣性矩／I值:</span>
                <input type="text" id="beam-I-disp" value="-" class="i-value-text" readonly>
                <span class="i-value-label">cm⁴</span>
            </div>
        </div>

        <div class="section">
            <h2>3. 立柱規格</h2>
            <label>選擇規格</label>
            <select id="col-spec-select" onchange="updateThicknessOptions()">
                <option value="">-- 請選擇 --</option>
            </select>
            
            <div style="margin-top:10px;">
                <label>選擇厚度</label>
                <select id="col-thick-select" onchange="applyColumnData()">
                    <option value="">--</option>
                </select>
            </div>

            <div class="input-row" style="margin-top:10px;">
                <div class="input-col">
                    <label>截面積 A</label>
                    <input type="number" id="col-area" value="4.92" readonly>
                </div>
                <div class="input-col">
                    <label>弱軸 Iy</label>
                    <input type="number" id="col-Iy" value="30.57" readonly>
                </div>
            </div>
        </div>

        <button onclick="calc()">開始計算</button>

        <div class="results-panel">
            <div id="card-beam" class="res-card">
                <div class="res-header">
                    <span class="res-title">橫樑撓度</span>
                    <span id="status-beam" class="res-status">計算中</span>
                </div>
                <div class="res-main" id="val-beam-def">- <span style="font-size:14px; font-weight:normal;">mm</span></div>
                <div class="res-sub">上限: <span id="val-beam-limit">-</span> mm (L/250)</div>
            </div>

            <div id="card-col" class="res-card">
                <div class="res-header">
                    <span class="res-title">立柱安全係數</span>
                    <span id="status-col" class="res-status">計算中</span>
                </div>
                <div class="res-main" id="val-col-sf">-</div>
                <div class="res-sub">狀態: <span id="val-col-msg">-</span></div>
            </div>
        </div>
    </div>

    <div class="visualizer">
        <canvas id="mainCanvas" width="600" height="750"></canvas>
        <div class="legend">
            <div><span class="dot" style="background:#3b82f6;"></span><span id="vis-beam-label">橫樑</span></div>
            <div><span class="dot" style="background:#22c55e;"></span>立柱</div>
            <div><span class="dot" style="background:#ef4444;"></span>變形警示</div>
        </div>
    </div>
</div>

<script>
    // 立柱資料庫
    const colDB = {
        "90*60": { "1.8": { A: 3.91, Iy: 17.21 }, "2.0": { A: 4.34, Iy: 19.13 } },
        "90*67": { "1.8": { A: 4.43, Iy: 27.55 }, "2.0": { A: 4.92, Iy: 30.57 }, "2.5": { A: 6.15, Iy: 38.05 } },
        "90*78": { "2.0": { A: 5.28, Iy: 42.50 }, "2.3": { A: 6.02, Iy: 48.81 }, "2.5": { A: 6.60, Iy: 53.00 } },
        "100*70": { "2.0": { A: 5.28, Iy: 36.03 }, "2.3": { A: 6.02, Iy: 41.33 }, "2.5": { A: 6.60, Iy: 44.85 } },
        "100*95": { "2.3": { A: 7.22, Iy: 87.06 }, "2.5": { A: 7.85, Iy: 94.54 }, "3.0": { A: 9.42, Iy: 113.18 } },
        "120*85": { "2.0": { A: 6.42, Iy: 65.41 }, "2.5": { A: 8.03, Iy: 81.49 }, "2.75": { A: 8.83, Iy: 89.48 } }
    };

    function initDropdowns() {
        const specSel = document.getElementById('col-spec-select');
        for (let spec in colDB) {
            let opt = document.createElement('option'); opt.value = spec; opt.text = spec; specSel.add(opt);
        }
        specSel.value = "90*67";
        updateThicknessOptions();
        document.getElementById('col-thick-select').value = "2.0";
        applyColumnData();
    }

    function updateThicknessOptions() {
        const specSel = document.getElementById('col-spec-select');
        const thickSel = document.getElementById('col-thick-select');
        const spec = specSel.value;
        thickSel.innerHTML = "";
        if (spec && colDB[spec]) {
            for (let t in colDB[spec]) {
                let opt = document.createElement('option'); opt.value = t; opt.text = t + " mm"; thickSel.add(opt);
            }
            thickSel.selectedIndex = 0;
            applyColumnData();
        } else {
            let opt = document.createElement('option'); opt.text = "--"; thickSel.add(opt);
        }
    }

    function applyColumnData() {
        const spec = document.getElementById('col-spec-select').value;
        const thick = document.getElementById('col-thick-select').value;
        if (spec && thick && colDB[spec][thick]) {
            const data = colDB[spec][thick];
            document.getElementById('col-area').value = data.A;
            document.getElementById('col-Iy').value = data.Iy;
            calc();
        }
    }

    // --- 橫樑切換與 I值計算 (V6.0 精確版) ---
    function updateBeamPreset() {
        const type = document.getElementById('beam-type').value;
        // 依據您的檔案設定標準高度
        if (type === 'C') {
            document.getElementById('beam-h').value = 100;
        } else if (type === 'G') {
            document.getElementById('beam-h').value = 120;
        } else if (type === 'B') {
            document.getElementById('beam-h').value = 105;
        }
        reCalcI();
    }

    function reCalcI() {
        const type = document.getElementById('beam-type').value;
        const H = parseFloat(document.getElementById('beam-h').value);
        const W = 50; // 鎖定
        const t = parseFloat(document.getElementById('beam-t').value);
        
        let h_inner = 0;
        let w_inner = W - 2*t; 

        // 依據檔案參數驗證後的精確幾何扣除邏輯
        if (type === 'B') {
            // B樑: 內高 = H - 2t
            h_inner = H - 2*t;
        } else if (type === 'C') {
            // C樑: 內高 = H - 4t (94 = 100 - 4*1.5)
            h_inner = H - 4*t;
        } else if (type === 'G') {
            // G樑: 內高 = H - 3t (115.5 = 120 - 3*1.5)
            h_inner = H - 3*t;
        }

        // 慣性矩公式 (矩形管中空扣除)
        // I = (W*H^3 - w*h^3) / 12
        const I_val = (W * Math.pow(H,3) - w_inner * Math.pow(h_inner, 3)) / 12;

        document.getElementById('beam-I-disp').value = (I_val / 10000).toFixed(2);
        calc();
    }

    function autoUpdateSpan() {
        const h = parseFloat(document.getElementById('h-total').value);
        const l = parseFloat(document.getElementById('levels').value);
        if(h && l) {
            document.getElementById('max-span').value = (h / l).toFixed(2);
        }
        calc();
    }

    function calc() {
        const layers = parseInt(document.getElementById('levels').value);
        const loadLayer = parseFloat(document.getElementById('load-layer').value);
        const hTotal = parseFloat(document.getElementById('h-total').value);
        const maxSpan = parseFloat(document.getElementById('max-span').value);
        
        const beamLen = parseFloat(document.getElementById('beam-len').value);
        const beamType = document.getElementById('beam-type').value;
        const beamI_cm4 = parseFloat(document.getElementById('beam-I-disp').value);

        const colIy = parseFloat(document.getElementById('col-Iy').value);

        document.getElementById('vis-beam-label').innerText = beamType + "樑";

        // Beam Calc
        const loadBeam = loadLayer / 2; 
        const E_beam = 21000; 
        const I_beam_mm4 = beamI_cm4 * 10000;
        const deltaBeam = (5 * loadBeam * Math.pow(beamLen, 3)) / (384 * E_beam * I_beam_mm4);
        const limitBeam = beamLen / 250;
        const isBeamSafe = deltaBeam <= limitBeam;

        // Col Calc
        const totalRackLoad = loadLayer * layers;
        const loadLeg = totalRackLoad / 4; 
        const loadLeg_N = loadLeg * 9.8;
        const L_eff_mm = maxSpan * 1000;
        const E_col = 200000; 
        const Iy_mm4 = colIy * 10000;
        const P_crit_N = (Math.pow(Math.PI, 2) * E_col * Iy_mm4) / Math.pow(L_eff_mm, 2);
        const sf = P_crit_N / loadLeg_N;

        // UI Update
        const elBeamVal = document.getElementById('val-beam-def');
        const elBeamCard = document.getElementById('card-beam');
        const elBeamStatus = document.getElementById('status-beam');
        
        elBeamVal.innerText = deltaBeam.toFixed(2);
        document.getElementById('val-beam-limit').innerText = limitBeam.toFixed(1);

        if(isBeamSafe) {
            elBeamCard.className = "res-card safe";
            elBeamStatus.innerText = "合格";
            elBeamStatus.style.background = "#dcfce7"; elBeamStatus.style.color = "#166534";
        } else {
            elBeamCard.className = "res-card danger";
            elBeamStatus.innerText = "不合格";
            elBeamStatus.style.background = "#fee2e2"; elBeamStatus.style.color = "#991b1b";
        }

        const elColVal = document.getElementById('val-col-sf');
        const elColCard = document.getElementById('card-col');
        const elColStatus = document.getElementById('status-col');
        const elColMsg = document.getElementById('val-col-msg');

        elColVal.innerText = sf.toFixed(2);

        let colState = 0; 
        if(sf < 1.0) {
            colState = 2;
            elColCard.className = "res-card danger";
            elColStatus.innerText = "危險";
            elColStatus.style.background = "#fee2e2"; elColStatus.style.color = "#991b1b";
            elColMsg.innerText = "結構有倒塌風險";
        } else if (sf < 2.0) {
            colState = 1;
            elColCard.className = "res-card warning";
            elColStatus.innerText = "不穩";
            elColStatus.style.background = "#fef3c7"; elColStatus.style.color = "#92400e";
            elColMsg.innerText = "安全係數偏低";
        } else {
            elColCard.className = "res-card safe";
            elColStatus.innerText = "安全";
            elColStatus.style.background = "#dcfce7"; elColStatus.style.color = "#166534";
            elColMsg.innerText = "設計符合標準";
        }

        drawSystem(hTotal, maxSpan, layers, deltaBeam, limitBeam, colState, sf);
    }

    function drawSystem(H_m, maxSpan, layers, beamDef, beamLimit, colState, sf) {
        const cvs = document.getElementById('mainCanvas');
        const ctx = cvs.getContext('2d');
        const W = cvs.width; const H = cvs.height;
        ctx.clearRect(0,0,W,H);

        const marginY = 60;
        const drawH = H - marginY*2;
        const scale = drawH / H_m; 
        
        ctx.beginPath();
        ctx.moveTo(80, H-marginY); ctx.lineTo(W-80, H-marginY);
        ctx.strokeStyle="#94a3b8"; ctx.lineWidth=4; ctx.stroke();

        const leftX = W*0.35;
        const rightX = W*0.65;
        
        let ratio = 1 / sf; if(ratio > 1.2) ratio = 1.2; 
        let colAmp = Math.pow(ratio, 2) * 35; 
        
        let colColor = "#22c55e";
        if(colState === 1) colColor = "#f59e0b";
        if(colState === 2) colColor = "#ef4444";

        ctx.strokeStyle = colColor; ctx.lineWidth = 8; ctx.lineCap = "round";
        
        const drawCol = (bx, dir) => {
            ctx.beginPath();
            for(let i=0; i<=100; i++) {
                let h_curr = (i/100)*H_m;
                let y = (H-marginY) - (h_curr * scale); 
                let phase = (h_curr / maxSpan) * Math.PI;
                let wave = Math.sin(phase);
                let off = wave * colAmp * dir; 
                if(i===0) ctx.moveTo(bx+off, y); else ctx.lineTo(bx+off, y);
            }
            ctx.stroke();
        };
        drawCol(leftX, -1);
        drawCol(rightX, 1);

        let beamVisualDef = (beamDef / beamLimit) * 20; 
        if(beamVisualDef > 30) beamVisualDef = 30; if(beamVisualDef < 0) beamVisualDef = 0;
        let beamColor = (beamDef > beamLimit) ? "#ef4444" : "#3b82f6";

        ctx.strokeStyle = beamColor; ctx.lineWidth = 6; ctx.fillStyle = "#1d4ed8"; 

        const avgSpan = H_m / layers; 
        for(let i=1; i<=layers; i++) {
            let h_pos = i * avgSpan;
            let y_base = (H-marginY) - (h_pos * scale);
            if(y_base < marginY) break;

            ctx.beginPath();
            ctx.moveTo(leftX + 4, y_base);
            ctx.quadraticCurveTo((leftX+rightX)/2, y_base + beamVisualDef, rightX - 4, y_base);
            ctx.stroke();

            ctx.beginPath(); ctx.arc(leftX, y_base, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(rightX, y_base, 5, 0, Math.PI*2); ctx.fill();
        }
        
        ctx.fillStyle = "#64748b"; ctx.font="14px Arial"; ctx.textAlign="center";
        ctx.fillText(`${H_m}m`, leftX - 40, (H/2));
        ctx.beginPath(); ctx.strokeStyle="#cbd5e0"; ctx.lineWidth=1;
        ctx.moveTo(leftX - 30, H-marginY); ctx.lineTo(leftX-30, marginY); ctx.stroke();
    }

    window.onload = function() {
        initDropdowns();
        updateBeamPreset(); // Init beam I
    };
</script>

</body>
</html>
