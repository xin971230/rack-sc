<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¨æ¶çµæ§‹è¨ˆç®—æ¨¡æ“¬å™¨ V6.0</title>
    <style>
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background-color: #f8fafc; color: #334155; margin: 0; padding: 20px; padding-bottom: 60px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; display: flex; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-radius: 12px; overflow: hidden; min-height: 900px; }
        
        /* å·¦å´åƒæ•¸å€ */
        .sidebar { flex: 0 0 420px; background: #fff; padding: 25px; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow-y: auto; height: 100vh; max-height: 950px; box-sizing: border-box; }
        
        h2 { margin: 0 0 15px 0; color: #1e293b; font-size: 18px; border-left: 4px solid #3b82f6; padding-left: 10px; font-weight: 700; }
        .section { margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid #f1f5f9; }
        
        label { display: block; font-weight: 600; margin-bottom: 6px; color: #64748b; font-size: 13px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-col { flex: 1; }
        
        input, select { width: 100%; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; box-sizing: border-box; transition: 0.2s; background: #fff; color: #334155; }
        input:focus, select:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        input[readonly] { background-color: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: default; }
        
        .i-value-wrapper { display: flex; justify-content: flex-end; align-items: center; margin-top: 5px; }
        .i-value-label { font-size: 12px; color: #cbd5e1; margin-right: 5px; }
        .i-value-text { font-size: 12px; color: #94a3b8; border: none; background: transparent; text-align: right; width: 80px; padding: 0; pointer-events: none; }

        .note { font-size: 12px; color: #94a3b8; margin-top: -5px; margin-bottom: 10px; line-height: 1.4; }

        button { width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        button:hover { background: #2563eb; }

        /* çµæœå„€è¡¨æ¿ */
        .results-panel { margin-top: 20px; border-top: 2px dashed #e2e8f0; padding-top: 20px; }
        .res-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #cbd5e0; }
        .res-card.safe { border-left-color: #22c55e; background: #f0fdf4; }
        .res-card.danger { border-left-color: #ef4444; background: #fef2f2; }
        .res-card.warning { border-left-color: #f59e0b; background: #fffbeb; }
        
        .res-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .res-title { font-weight: 700; color: #475569; font-size: 13px; }
        .res-status { font-weight: 700; font-size: 11px; padding: 2px 8px; border-radius: 10px; }
        .res-main { font-size: 22px; font-weight: 800; color: #0f172a; }
        .res-sub { font-size: 12px; color: #64748b; }

        /* è¨ˆç®—ç´°ç¯€å€ (æ–°) */
        .calc-details { margin-top: 15px; background: #f8fafc; padding: 15px; border-radius: 6px; font-size: 12px; color: #475569; display: none; border: 1px solid #e2e8f0; }
        .calc-details h3 { margin: 0 0 10px 0; font-size: 13px; color: #334155; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .calc-row { margin-bottom: 8px; font-family: Consolas, monospace; }
        .calc-formula { color: #2563eb; display: block; margin-bottom: 2px; }
        .calc-val { color: #0f172a; padding-left: 10px; border-left: 2px solid #cbd5e1; }
        
        .sf-standards { margin-top: 10px; font-size: 11px; color: #64748b; background: #fff; padding: 8px; border-radius: 4px; border: 1px dashed #cbd5e1; }
        .sf-level { display: flex; justify-content: space-between; margin-bottom: 2px; }

        /* å³å´è¦–è¦ºå€ */
        .visualizer { flex: 1; background: #1e293b; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        canvas { background: #fff; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 90vh; }
        .legend { margin-top: 15px; color: #cbd5e0; font-size: 12px; display: flex; gap: 15px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        /* åº•éƒ¨æ‡¸æµ®ç‰ˆæœ¬ç´€éŒ„ */
        .changelog-btn { position: fixed; bottom: 20px; right: 20px; background: #475569; color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 14px; font-weight: bold; z-index: 1000; transition: 0.3s; }
        .changelog-btn:hover { background: #334155; transform: translateY(-2px); }
        
        .changelog-panel { position: fixed; bottom: 80px; right: 20px; width: 350px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 20px; z-index: 999; display: none; max-height: 60vh; overflow-y: auto; border: 1px solid #e2e8f0; }
        .changelog-panel h3 { margin-top: 0; color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .log-item { margin-bottom: 15px; font-size: 13px; }
        .log-ver { font-weight: bold; color: #3b82f6; display: block; margin-bottom: 4px; }
        .log-desc { color: #64748b; line-height: 1.5; margin: 0; padding-left: 10px; border-left: 3px solid #f1f5f9; }

    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="section">
            <h2>1. è²¨æ¶æ•´é«”é…ç½®</h2>
            <div class="input-row">
                <div class="input-col">
                    <label>ç«‹æŸ±ç¸½é«˜ (m)</label>
                    <input type="number" id="h-total" value="6.0" step="0.5" onchange="autoUpdateSpan()">
                </div>
                <div class="input-col">
                    <label>å±¤æ•¸</label>
                    <input type="number" id="levels" value="3" onchange="autoUpdateSpan()">
                </div>
            </div>

            <label style="color:#d97706;">æœ€å¤§å±¤è· (m) <span style="font-weight:normal; font-size:0.8em;">(ç„¡æ”¯æ’é•·åº¦)</span></label>
            <input type="number" id="max-span" value="2.0" step="0.1" onchange="calc()">

            <div style="margin-top:12px;">
                <label>å–®å±¤è·é‡ (kg)</label>
                <input type="number" id="load-layer" value="1000" onchange="calc()">
                <div class="note">ç³»çµ±è‡ªå‹•é™¤ä»¥2è¨ˆç®—å–®æ”¯æ©«æ¨‘</div>
            </div>
        </div>

        <div class="section" style="border-left: 4px solid #8b5cf6;">
            <h2>2. æ©«æ¨‘è¦æ ¼</h2>
            <label>æ©«æ¨‘é¡å‹</label>
            <select id="beam-type" onchange="updateBeamPreset()">
                <option value="C">Cæ¨‘</option>
                <option value="B">Bæ¨‘</option>
                <option value="G">Gæ¨‘</option>
            </select>

            <div class="input-row" style="margin-top:10px;">
                <div class="input-col">
                    <label>é•·åº¦ L (mm)</label>
                    <input type="number" id="beam-len" value="2500" onchange="calc()">
                </div>
                <div class="input-col">
                    <label>æŠ˜é«˜ H (mm)</label>
                    <input type="number" id="beam-h" value="100" onchange="reCalcI()">
                </div>
            </div>

            <div class="input-row">
                <div class="input-col">
                    <label>å¯¬åº¦ W (mm)</label>
                    <input type="number" id="beam-w" value="50" readonly>
                </div>
                <div class="input-col">
                    <label>åšåº¦ t (mm)</label>
                    <input type="number" id="beam-t" value="1.5" step="0.1" onchange="reCalcI()">
                </div>
            </div>

            <div class="i-value-wrapper">
                <span class="i-value-label">2æ¬¡æ–·é¢æ…£æ€§çŸ©ï¼Iå€¼:</span>
                <input type="text" id="beam-I-disp" value="-" class="i-value-text" readonly>
                <span class="i-value-label">cmâ´</span>
            </div>
        </div>

        <div class="section">
            <h2>3. ç«‹æŸ±è¦æ ¼</h2>
            <label>é¸æ“‡è¦æ ¼</label>
            <select id="col-spec-select" onchange="updateThicknessOptions()">
                <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
            
            <div style="margin-top:10px;">
                <label>é¸æ“‡åšåº¦</label>
                <select id="col-thick-select" onchange="applyColumnData()">
                    <option value="">--</option>
                </select>
            </div>

            <div class="input-row" style="margin-top:10px;">
                <div class="input-col">
                    <label>æˆªé¢ç© A</label>
                    <input type="number" id="col-area" value="4.92" readonly>
                </div>
                <div class="input-col">
                    <label>å¼±è»¸ Iy</label>
                    <input type="number" id="col-Iy" value="30.57" readonly>
                </div>
            </div>
        </div>

        <button onclick="calc()">é–‹å§‹è¨ˆç®—</button>

        <div class="results-panel">
            <div id="card-beam" class="res-card">
                <div class="res-header">
                    <span class="res-title">æ©«æ¨‘æ’“åº¦</span>
                    <span id="status-beam" class="res-status">è¨ˆç®—ä¸­</span>
                </div>
                <div class="res-main" id="val-beam-def">- <span style="font-size:14px; font-weight:normal;">mm</span></div>
                <div class="res-sub">ä¸Šé™: <span id="val-beam-limit">-</span> mm (L/250)</div>
            </div>

            <div id="card-col" class="res-card">
                <div class="res-header">
                    <span class="res-title">ç«‹æŸ±å®‰å…¨ä¿‚æ•¸</span>
                    <span id="status-col" class="res-status">è¨ˆç®—ä¸­</span>
                </div>
                <div class="res-main" id="val-col-sf">-</div>
                <div class="sf-standards">
                    <div class="sf-level"><span style="color:#ef4444">â— å±éšª (Collapse)</span> <span>SF < 1.0</span></div>
                    <div class="sf-level"><span style="color:#f59e0b">â— è­¦å‘Š (Unstable)</span> <span>1.0 â‰¤ SF < 2.0</span></div>
                    <div class="sf-level"><span style="color:#22c55e">â— å®‰å…¨ (Safe)</span> <span>SF â‰¥ 2.0</span></div>
                </div>
            </div>

            <div id="calc-details" class="calc-details">
                <h3>ğŸ§® è¨ˆç®—éç¨‹è©³è§£</h3>
                <div id="calc-content"></div>
            </div>
        </div>
    </div>

    <div class="visualizer">
        <canvas id="mainCanvas" width="600" height="750"></canvas>
        <div class="legend">
            <div><span class="dot" style="background:#3b82f6;"></span><span id="vis-beam-label">æ©«æ¨‘</span></div>
            <div><span class="dot" style="background:#22c55e;"></span>ç«‹æŸ±</div>
            <div><span class="dot" style="background:#ef4444;"></span>è®Šå½¢è­¦ç¤º</div>
        </div>
    </div>
</div>

<div class="changelog-btn" onclick="toggleChangelog()">ğŸ“œ ç‰ˆæœ¬ç´€éŒ„ (Changelog)</div>
<div class="changelog-panel" id="changelog-panel">
    <h3>ç‰ˆæœ¬æ›´æ–°æ­·ç¨‹</h3>
    
    <div class="log-item">
        <span class="log-ver">V6.0 (Current)</span>
        <p class="log-desc">
            1. ä»‹é¢ç²¾ç°¡å„ªåŒ–ï¼Œç§»é™¤æ¨™é¡Œæ‹¬è™Ÿã€‚<br>
            2. æ–°å¢è¨ˆç®—éç¨‹è©³ç´°åˆ—å¼ã€‚<br>
            3. æ˜ç¢ºåˆ—å‡ºå®‰å…¨ä¿‚æ•¸åˆ¤å®šæ¨™æº–ã€‚<br>
            4. æ…£æ€§çŸ©è¨ˆç®—æ¡ç”¨å¹¾ä½•æ‰£é™¤æ³• (Cæ¨‘-4t, Gæ¨‘-3t, Bæ¨‘-2t)ã€‚
        </p>
    </div>
    <div class="log-item">
        <span class="log-ver">V5.0</span>
        <p class="log-desc">
            1. ä¿®æ­£æ©«æ¨‘æ…£æ€§çŸ©å…¬å¼ï¼Œèˆ‡ PDF æ•¸æ“šå®Œå…¨æ ¡æ­£ã€‚<br>
            2. æ©«æ¨‘å¯¬åº¦é–å®šç‚º 50mmã€‚<br>
            3. æ…£æ€§çŸ© I å€¼æ”¹ç‚ºå”¯è®€é¡¯ç¤ºã€‚
        </p>
    </div>
    <div class="log-item">
        <span class="log-ver">V4.0</span>
        <p class="log-desc">
            1. æ–°å¢ C/B/G ä¸‰ç¨®æ¨‘å‹é¸é …ã€‚<br>
            2. å…§å»ºä¸åŒæ¨‘å‹çš„ä¿®æ­£ä¿‚æ•¸ã€‚
        </p>
    </div>
    <div class="log-item">
        <span class="log-ver">V3.0</span>
        <p class="log-desc">
            1. æ•´åˆç«‹æŸ±èˆ‡æ©«æ¨‘è¨ˆç®—æ–¼åŒä¸€ä»‹é¢ã€‚<br>
            2. æ–°å¢æœ€å¤§å±¤è· (Max Span) é‚è¼¯ã€‚
        </p>
    </div>
    <div class="log-item">
        <span class="log-ver">V1.0 - V2.0</span>
        <p class="log-desc">
            1. åŸºç¤ç«‹æŸ±æŒ«å±ˆè¨ˆç®—ã€‚<br>
            2. å¼•å…¥ Canvas è¦–è¦ºåŒ–æ¨¡æ“¬ã€‚
        </p>
    </div>
</div>

<script>
    // ç«‹æŸ±è³‡æ–™åº«
    const colDB = {
        "90*60": { "1.8": { A: 3.91, Iy: 17.21 }, "2.0": { A: 4.34, Iy: 19.13 } },
        "90*67": { "1.8": { A: 4.43, Iy: 27.55 }, "2.0": { A: 4.92, Iy: 30.57 }, "2.5": { A: 6.15, Iy: 38.05 } },
        "90*78": { "2.0": { A: 5.28, Iy: 42.50 }, "2.3": { A: 6.02, Iy: 48.81 }, "2.5": { A: 6.60, Iy: 53.00 } },
        "100*70": { "2.0": { A: 5.28, Iy: 36.03 }, "2.3": { A: 6.02, Iy: 41.33 }, "2.5": { A: 6.60, Iy: 44.85 } },
        "100*95": { "2.3": { A: 7.22, Iy: 87.06 }, "2.5": { A: 7.85, Iy: 94.54 }, "3.0": { A: 9.42, Iy: 113.18 } },
        "120*85": { "2.0": { A: 6.42, Iy: 65.41 }, "2.5": { A: 8.03, Iy: 81.49 }, "2.75": { A: 8.83, Iy: 89.48 } }
    };

    function initDropdowns() {
        const specSel = document.getElementById('col-spec-select');
        for (let spec in colDB) {
            let opt = document.createElement('option'); opt.value = spec; opt.text = spec; specSel.add(opt);
        }
        specSel.value = "90*67";
        updateThicknessOptions();
        document.getElementById('col-thick-select').value = "2.0";
        applyColumnData();
    }

    function updateThicknessOptions() {
        const specSel = document.getElementById('col-spec-select');
        const thickSel = document.getElementById('col-thick-select');
        const spec = specSel.value;
        thickSel.innerHTML = "";
        if (spec && colDB[spec]) {
            for (let t in colDB[spec]) {
                let opt = document.createElement('option'); opt.value = t; opt.text = t + " mm"; thickSel.add(opt);
            }
            thickSel.selectedIndex = 0;
            applyColumnData();
        } else {
            let opt = document.createElement('option'); opt.text = "--"; thickSel.add(opt);
        }
    }

    function applyColumnData() {
        const spec = document.getElementById('col-spec-select').value;
        const thick = document.getElementById('col-thick-select').value;
        if (spec && thick && colDB[spec][thick]) {
            const data = colDB[spec][thick];
            document.getElementById('col-area').value = data.A;
            document.getElementById('col-Iy').value = data.Iy;
            calc();
        }
    }

    function updateBeamPreset() {
        const type = document.getElementById('beam-type').value;
        if (type === 'C') document.getElementById('beam-h').value = 100;
        else if (type === 'G') document.getElementById('beam-h').value = 120;
        else if (type === 'B') document.getElementById('beam-h').value = 105;
        reCalcI();
    }

    function reCalcI() {
        const type = document.getElementById('beam-type').value;
        const H = parseFloat(document.getElementById('beam-h').value);
        const W = 50; 
        const t = parseFloat(document.getElementById('beam-t').value);
        
        let h_inner = H - (type === 'C' ? 4*t : (type === 'G' ? 3*t : 2*t));
        let w_inner = W - 2*t; 
        const I_val = (W * Math.pow(H,3) - w_inner * Math.pow(h_inner, 3)) / 12;

        document.getElementById('beam-I-disp').value = (I_val / 10000).toFixed(2);
        calc();
    }

    function autoUpdateSpan() {
        const h = parseFloat(document.getElementById('h-total').value);
        const l = parseFloat(document.getElementById('levels').value);
        if(h && l) document.getElementById('max-span').value = (h / l).toFixed(2);
        calc();
    }

    function toggleChangelog() {
        const panel = document.getElementById('changelog-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function calc() {
        const layers = parseInt(document.getElementById('levels').value);
        const loadLayer = parseFloat(document.getElementById('load-layer').value);
        const hTotal = parseFloat(document.getElementById('h-total').value);
        const maxSpan = parseFloat(document.getElementById('max-span').value);
        
        const beamLen = parseFloat(document.getElementById('beam-len').value);
        const beamType = document.getElementById('beam-type').value;
        const beamI_cm4 = parseFloat(document.getElementById('beam-I-disp').value);

        const colIy = parseFloat(document.getElementById('col-Iy').value);

        document.getElementById('vis-beam-label').innerText = beamType + "æ¨‘";

        // --- è¨ˆç®—æ ¸å¿ƒ ---
        
        // 1. Beam
        const loadBeam = loadLayer / 2; 
        const E_beam = 21000; 
        const I_beam_mm4 = beamI_cm4 * 10000;
        const deltaBeam = (5 * loadBeam * Math.pow(beamLen, 3)) / (384 * E_beam * I_beam_mm4);
        const limitBeam = beamLen / 250;
        const isBeamSafe = deltaBeam <= limitBeam;

        // 2. Col
        const totalRackLoad = loadLayer * layers;
        const loadLeg = totalRackLoad / 4; 
        const loadLeg_N = loadLeg * 9.8;
        const L_eff_mm = maxSpan * 1000;
        const E_col = 200000; 
        const Iy_mm4 = colIy * 10000;
        const P_crit_N = (Math.pow(Math.PI, 2) * E_col * Iy_mm4) / Math.pow(L_eff_mm, 2);
        const sf = P_crit_N / loadLeg_N;

        // --- æ›´æ–° UI é¡¯ç¤º ---
        
        const elBeamVal = document.getElementById('val-beam-def');
        const elBeamCard = document.getElementById('card-beam');
        const elBeamStatus = document.getElementById('status-beam');
        
        elBeamVal.innerText = deltaBeam.toFixed(2);
        document.getElementById('val-beam-limit').innerText = limitBeam.toFixed(1);

        if(isBeamSafe) {
            elBeamCard.className = "res-card safe";
            elBeamStatus.innerText = "åˆæ ¼";
            elBeamStatus.style.background = "#dcfce7"; elBeamStatus.style.color = "#166534";
        } else {
            elBeamCard.className = "res-card danger";
            elBeamStatus.innerText = "ä¸åˆæ ¼";
            elBeamStatus.style.background = "#fee2e2"; elBeamStatus.style.color = "#991b1b";
        }

        const elColVal = document.getElementById('val-col-sf');
        const elColCard = document.getElementById('card-col');
        const elColStatus = document.getElementById('status-col');

        elColVal.innerText = sf.toFixed(2);

        let colState = 0; 
        if(sf < 1.0) {
            colState = 2;
            elColCard.className = "res-card danger";
            elColStatus.innerText = "å±éšª";
            elColStatus.style.background = "#fee2e2"; elColStatus.style.color = "#991b1b";
        } else if (sf < 2.0) {
            colState = 1;
            elColCard.className = "res-card warning";
            elColStatus.innerText = "ä¸ç©©";
            elColStatus.style.background = "#fef3c7"; elColStatus.style.color = "#92400e";
        } else {
            elColCard.className = "res-card safe";
            elColStatus.innerText = "å®‰å…¨";
            elColStatus.style.background = "#dcfce7"; elColStatus.style.color = "#166534";
        }

        // --- ç”Ÿæˆè¨ˆç®—éç¨‹ (Requirement 1) ---
        const detailsDiv = document.getElementById('calc-details');
        const contentDiv = document.getElementById('calc-content');
        detailsDiv.style.display = "block";
        
        contentDiv.innerHTML = `
            <div class="calc-row">
                <span class="calc-formula">1. æ©«æ¨‘æ…£æ€§çŸ© (I)</span>
                <div class="calc-val">å…¬å¼: (WHÂ³ - whÂ³) / 12</div>
                <div class="calc-val">I = ${beamI_cm4.toFixed(2)} cmâ´ = ${I_beam_mm4.toFixed(0)} mmâ´</div>
            </div>
            <div class="calc-row">
                <span class="calc-formula">2. æ©«æ¨‘æ’“åº¦ (Î´)</span>
                <div class="calc-val">å…¬å¼: (5 Ã— W Ã— LÂ³) / (384 Ã— E Ã— I)</div>
                <div class="calc-val">W=${loadBeam}kg, L=${beamLen}mm, E=${E_beam}</div>
                <div class="calc-val">Î´ = ${(5 * loadBeam * Math.pow(beamLen, 3) / (384 * E_beam * I_beam_mm4)).toFixed(2)} mm</div>
            </div>
            <div class="calc-row">
                <span class="calc-formula">3. ç«‹æŸ±è‡¨ç•Œè¼‰é‡ (Pcr)</span>
                <div class="calc-val">å…¬å¼: (Ï€Â² Ã— E Ã— Iy) / LÂ²</div>
                <div class="calc-val">E=${E_col}, Iy=${Iy_mm4.toFixed(0)}, L=${L_eff_mm}</div>
                <div class="calc-val">Pcr = ${(P_crit_N/9.8).toFixed(0)} kg</div>
            </div>
            <div class="calc-row">
                <span class="calc-formula">4. å®‰å…¨ä¿‚æ•¸ (SF)</span>
                <div class="calc-val">å…¬å¼: Pcr / P_actual</div>
                <div class="calc-val">P_actual = ${loadLeg.toFixed(0)} kg</div>
                <div class="calc-val">SF = ${sf.toFixed(2)}</div>
            </div>
        `;

        drawSystem(hTotal, maxSpan, layers, deltaBeam, limitBeam, colState, sf);
    }

    function drawSystem(H_m, maxSpan, layers, beamDef, beamLimit, colState, sf) {
        const cvs = document.getElementById('mainCanvas');
        const ctx = cvs.getContext('2d');
        const W = cvs.width; const H = cvs.height;
        ctx.clearRect(0,0,W,H);

        const marginY = 60;
        const drawH = H - marginY*2;
        const scale = drawH / H_m; 
        
        ctx.beginPath();
        ctx.moveTo(80, H-marginY); ctx.lineTo(W-80, H-marginY);
        ctx.strokeStyle="#94a3b8"; ctx.lineWidth=4; ctx.stroke();

        const leftX = W*0.35;
        const rightX = W*0.65;
        
        let ratio = 1 / sf; if(ratio > 1.2) ratio = 1.2; 
        let colAmp = Math.pow(ratio, 2) * 35; 
        
        let colColor = "#22c55e";
        if(colState === 1) colColor = "#f59e0b";
        if(colState === 2) colColor = "#ef4444";

        ctx.strokeStyle = colColor; ctx.lineWidth = 8; ctx.lineCap = "round";
        
        const drawCol = (bx, dir) => {
            ctx.beginPath();
            for(let i=0; i<=100; i++) {
                let h_curr = (i/100)*H_m;
                let y = (H-marginY) - (h_curr * scale); 
                let phase = (h_curr / maxSpan) * Math.PI;
                let wave = Math.sin(phase);
                let off = wave * colAmp * dir; 
                if(i===0) ctx.moveTo(bx+off, y); else ctx.lineTo(bx+off, y);
            }
            ctx.stroke();
        };
        drawCol(leftX, -1);
        drawCol(rightX, 1);

        let beamVisualDef = (beamDef / beamLimit) * 20; 
        if(beamVisualDef > 30) beamVisualDef = 30; if(beamVisualDef < 0) beamVisualDef = 0;
        let beamColor = (beamDef > beamLimit) ? "#ef4444" : "#3b82f6";

        ctx.strokeStyle = beamColor; ctx.lineWidth = 6; ctx.fillStyle = "#1d4ed8"; 

        const avgSpan = H_m / layers; 
        for(let i=1; i<=layers; i++) {
            let h_pos = i * avgSpan;
            let y_base = (H-marginY) - (h_pos * scale);
            if(y_base < marginY) break;

            ctx.beginPath();
            ctx.moveTo(leftX + 4, y_base);
            ctx.quadraticCurveTo((leftX+rightX)/2, y_base + beamVisualDef, rightX - 4, y_base);
            ctx.stroke();

            ctx.beginPath(); ctx.arc(leftX, y_base, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(rightX, y_base, 5, 0, Math.PI*2); ctx.fill();
        }
        
        ctx.fillStyle = "#64748b"; ctx.font="14px Arial"; ctx.textAlign="center";
        ctx.fillText(`${H_m}m`, leftX - 40, (H/2));
        ctx.beginPath(); ctx.strokeStyle="#cbd5e0"; ctx.lineWidth=1;
        ctx.moveTo(leftX - 30, H-marginY); ctx.lineTo(leftX-30, marginY); ctx.stroke();
    }

    window.onload = function() {
        initDropdowns();
        updateBeamPreset(); 
    };
</script>

</body>
</html>
