<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åŠŸèƒ½è²¨æ¶çµæ§‹è¨ˆç®—æ¨¡æ“¬å™¨ (ç«‹æŸ±+Cæ¨‘é€£å‹•ç‰ˆ)</title>
    <style>
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background-color: #f0f3f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; display: flex; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-radius: 16px; overflow: hidden; min-height: 800px; }
        
        /* å·¦å´åƒæ•¸å€ */
        .sidebar { flex: 0 0 380px; background: #fff; padding: 30px; border-right: 1px solid #e1e8ed; display: flex; flex-direction: column; overflow-y: auto; height: 100vh; max-height: 900px; box-sizing: border-box; }
        
        h2 { margin: 0 0 15px 0; color: #2c3e50; font-size: 20px; border-left: 5px solid #3498db; padding-left: 10px; }
        .section { margin-bottom: 25px; background: #f9fbfc; padding: 15px; border-radius: 8px; border: 1px solid #edf2f7; }
        
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; font-size: 13px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-col { flex: 1; }
        input { width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 15px; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        
        .note { font-size: 12px; color: #888; margin-top: -5px; margin-bottom: 10px; line-height: 1.4; }
        .calc-val { font-size: 12px; color: #2980b9; font-weight: bold; background: #eaf2f8; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; }

        button { width: 100%; padding: 15px; background: linear-gradient(135deg, #2980b9, #3498db); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; box-shadow: 0 4px 12px rgba(52,152,219,0.25); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(52,152,219,0.35); }

        /* çµæœå„€è¡¨æ¿ */
        .results-panel { margin-top: 20px; }
        .res-card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 5px solid #bdc3c7; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .res-card.safe { border-left-color: #2ecc71; background: #f0fdf4; }
        .res-card.danger { border-left-color: #e74c3c; background: #fef2f2; }
        .res-card.warning { border-left-color: #f39c12; background: #fefcf5; }
        
        .res-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .res-title { font-weight: bold; color: #4a5568; font-size: 14px; }
        .res-status { font-weight: bold; font-size: 13px; padding: 2px 8px; border-radius: 12px; }
        .res-main { font-size: 24px; font-weight: 800; color: #2d3748; }
        .res-sub { font-size: 12px; color: #718096; }

        /* å³å´è¦–è¦ºå€ */
        .visualizer { flex: 1; background: #2c3e50; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        canvas { background: #fff; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 90vh; }
        .vis-info { position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.8); font-size: 14px; }
        .legend { margin-top: 15px; color: #bdc3c7; font-size: 12px; display: flex; gap: 15px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        
        <div class="section">
            <h2>1. è²¨æ¶æ•´é«”é…ç½®</h2>
            <div class="input-row">
                <div class="input-col">
                    <label>å±¤æ•¸ (Levels)</label>
                    <input type="number" id="levels" value="3" onchange="calc()">
                </div>
                <div class="input-col">
                    <label>å–®å±¤è·é‡ (kg)</label>
                    <input type="number" id="load-layer" value="1000" onchange="calc()">
                </div>
            </div>
            <div class="note">âš ï¸ è¼¸å…¥ 1000kgï¼Œè¨ˆç®—æ©«æ¨‘æ™‚æœƒä»¥ 500kg (1/2) æª¢æ ¸</div>
            
            <label>ç«‹æŸ±ç¸½é«˜åº¦ (ç±³)</label>
            <input type="number" id="h-total" value="6.0" step="0.5" onchange="calc()">
        </div>

        <div class="section">
            <h2>2. æ©«æ¨‘è¦æ ¼ (Cæ¨‘)</h2>
            <label>æ©«æ¨‘é•·åº¦ L (mm)</label>
            <input type="number" id="beam-len" value="2500" onchange="calc()">
            
            <div class="input-row">
                <div class="input-col">
                    <label>æŠ˜é«˜ H (mm)</label>
                    <input type="number" id="beam-h" value="100" onchange="calc()">
                </div>
                <div class="input-col">
                    <div style="padding-top:25px;">
                        <span id="beam-i-disp" class="calc-val">I â‰ˆ 91.3 cmâ´</span>
                    </div>
                </div>
            </div>
            <div class="note">æ›´æ”¹æŠ˜é«˜æœƒè‡ªå‹•è¨ˆç®—æ–°çš„æ…£æ€§çŸ© (æ¨¡æ“¬é›™CæŠ±ç„Š)</div>
        </div>

        <div class="section">
            <h2>3. ç«‹æŸ±è¦æ ¼</h2>
            <div class="input-row">
                <div class="input-col">
                    <label>æˆªé¢ç© A (cmÂ²)</label>
                    <input type="number" id="col-area" value="4.92" step="0.1" onchange="calc()">
                </div>
                <div class="input-col">
                    <label>å¼±è»¸ Iy (cmâ´)</label>
                    <input type="number" id="col-Iy" value="28" step="0.1" onchange="calc()">
                </div>
            </div>
        </div>

        <button onclick="calc()">ğŸš€ åŸ·è¡Œå…¨ç³»çµ±è¨ˆç®—</button>

        <div class="results-panel">
            <div id="card-beam" class="res-card">
                <div class="res-header">
                    <span class="res-title">æ©«æ¨‘æ’“åº¦ (Beam Deflection)</span>
                    <span id="status-beam" class="res-status" style="background:#eee; color:#555;">è¨ˆç®—ä¸­</span>
                </div>
                <div class="res-main" id="val-beam-def">- mm</div>
                <div class="res-sub">æª¢æ ¸è·é‡: <span id="val-beam-load">-</span> kg (L/250 æ¨™æº–)</div>
            </div>

            <div id="card-col" class="res-card">
                <div class="res-header">
                    <span class="res-title">ç«‹æŸ±å®‰å…¨ä¿‚æ•¸ (Safety Factor)</span>
                    <span id="status-col" class="res-status" style="background:#eee; color:#555;">è¨ˆç®—ä¸­</span>
                </div>
                <div class="res-main" id="val-col-sf">-</div>
                <div class="res-sub">å–®æ”¯å—åŠ›: <span id="val-col-load">-</span> kg | æ©«æ¨‘é–“è·: <span id="val-span">-</span> m</div>
            </div>
        </div>
    </div>

    <div class="visualizer">
        <div class="vis-info">
            <strong>å…¨ç³»çµ±æ¨¡æ“¬è¦–åœ–</strong><br>
            æ¨¡æ“¬åŒ…å«æ©«æ¨‘æ’“åº¦èˆ‡ç«‹æŸ±æŒ«å±ˆ
        </div>
        <canvas id="mainCanvas" width="600" height="750"></canvas>
        <div class="legend">
            <div><span class="dot" style="background:#3498db;"></span>Cå‹æ©«æ¨‘</div>
            <div><span class="dot" style="background:#2ecc71;"></span>ç«‹æŸ±(å®‰å…¨)</div>
            <div><span class="dot" style="background:#e74c3c;"></span>è®Šå½¢/å±éšª</div>
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–åŸ·è¡Œ
    window.onload = calc;

    function calc() {
        // --- 1. è®€å–è¼¸å…¥ ---
        const layers = parseInt(document.getElementById('levels').value);
        const loadLayer = parseFloat(document.getElementById('load-layer').value);
        const hTotal = parseFloat(document.getElementById('h-total').value);
        
        const beamLen = parseFloat(document.getElementById('beam-len').value);
        const beamH = parseFloat(document.getElementById('beam-h').value);
        
        const colArea = parseFloat(document.getElementById('col-area').value);
        const colIy = parseFloat(document.getElementById('col-Iy').value);

        if(!layers || !loadLayer || !hTotal || !beamLen || !beamH) return;

        // --- 2. æ©«æ¨‘è¨ˆç®— (Beam Calculation) ---
        // é‚è¼¯ï¼šè¼¸å…¥è·é‡æ˜¯å–®å±¤ç¸½é‡ï¼Œæ©«æ¨‘è¨ˆç®—ç”¨ä¸€åŠ
        const loadBeam = loadLayer / 2;
        
        // å‹•æ…‹è¨ˆç®—æ…£æ€§çŸ© I
        // åŸºæº–: 100x50x1.5 => I ~ 91.35 cm4 = 913546 mm4
        // ä½¿ç”¨å¹¾ä½•è¿‘ä¼¼å…¬å¼: I æ­£æ¯”æ–¼ 2 * ( (B*H^3)/12 - ((B-t)*(H-2t)^3)/12 )
        // æˆ‘å€‘ç”¨ä¸€å€‹ç°¡åŒ–çš„æ¯”ä¾‹æ³•ï¼ŒåŸºæ–¼ H=100 ç‚ºåŸºæº–é»
        // I_approx = k * (H^3 - (H-3)^3) ... é¡ä¼¼é€™æ¨£ï¼Œæˆ–è€…ç›´æ¥ç”¨ç‰©ç†å…¬å¼ç®—
        
        // è®“æˆ‘å€‘ç”¨ç‰©ç†å…¬å¼ç®—ç²¾ç¢ºä¸€é» (å‡è¨­ B=50, t=1.5 å›ºå®šï¼Œåªæ”¹ H)
        const B = 50, t = 1.5;
        const H_mm = beamH;
        // å¤–æ¡†æ…£æ€§çŸ© - å…§æ¡†æ…£æ€§çŸ©
        const I_outer = (B * Math.pow(H_mm, 3)) / 12;
        const I_inner = ((B - t) * Math.pow(H_mm - 2*t, 3)) / 12;
        // é€™æ˜¯å–®æ”¯ Cï¼Œé›™ C æŠ±ç„Šå‰‡ x 2
        // ä½†æŠ±ç„Šçµæ§‹ä¸¦éå®Œç¾ 2 å€ï¼Œä¸”æœ‰ç„Šæ¥å½±éŸ¿ã€‚
        // æˆ‘å€‘ç”¨ "913546 (for H=100)" / "Theoretical (for H=100)" ä½œç‚ºä¿®æ­£ä¿‚æ•¸
        
        // Theoretical Double C for H=100:
        const I_outer_100 = (50 * Math.pow(100, 3)) / 12; // 4,166,666
        const I_inner_100 = (48.5 * Math.pow(97, 3)) / 12; // 3,689,036
        const I_theo_100 = 2 * (I_outer_100 - I_inner_100); // 2 * 477,630 = 955,260
        
        const correctionFactor = 913546 / 955260; // ~0.956

        let I_beam_calc = 2 * (I_outer - I_inner) * correctionFactor; // mm4
        
        // æ›´æ–° UI é¡¯ç¤º I å€¼
        document.getElementById('beam-i-disp').innerText = `I â‰ˆ ${(I_beam_calc/10000).toFixed(1)} cmâ´`;

        // æ’“åº¦è¨ˆç®—
        const E_beam = 21000; // kg/mm2
        // delta = 5 * W * L^3 / (384 * E * I)
        const deltaBeam = (5 * loadBeam * Math.pow(beamLen, 3)) / (384 * E_beam * I_beam_calc);
        const limitBeam = beamLen / 250;
        const isBeamSafe = deltaBeam <= limitBeam;

        // --- 3. ç«‹æŸ±è¨ˆç®— (Upright Calculation) ---
        // é‚è¼¯ï¼šç¸½é‡ = å–®å±¤è·é‡ * å±¤æ•¸ã€‚ å–®æ”¯è…³ = ç¸½é‡ / 4
        const totalRackLoad = loadLayer * layers;
        const loadLeg = totalRackLoad / 4; // kg
        const loadLeg_N = loadLeg * 9.8;
        
        // æ©«æ¨‘é–“è· (Span) = ç¸½é«˜ / å±¤æ•¸ (æˆ–æ˜¯ (å±¤æ•¸+1)? é€šå¸¸ç¬¬ä¸€å±¤é›¢åœ°ä¹Ÿæœ‰é«˜åº¦)
        // å‡è¨­å‡å‹»åˆ†ä½ˆï¼š Span = H / Layers
        // ä¾‹å¦‚ 6ç±³é«˜ï¼Œ3å±¤ => 2ç±³ä¸€å±¤
        const span_m = hTotal / layers; 
        const L_eff_mm = span_m * 1000;

        const E_col = 200000; // MPa (N/mm2)
        const Iy_mm4 = colIy * 10000;
        
        // æŒ«å±ˆè‡¨ç•Œè¼‰é‡
        const P_crit_N = (Math.pow(Math.PI, 2) * E_col * Iy_mm4) / Math.pow(L_eff_mm, 2);
        const sf = P_crit_N / loadLeg_N;
        
        // --- 4. æ›´æ–°çµæœé¢æ¿ ---
        // Beam
        const elBeamVal = document.getElementById('val-beam-def');
        const elBeamCard = document.getElementById('card-beam');
        const elBeamStatus = document.getElementById('status-beam');
        
        elBeamVal.innerText = `${deltaBeam.toFixed(2)} mm`;
        document.getElementById('val-beam-load').innerText = loadBeam;
        
        if(isBeamSafe) {
            elBeamCard.className = "res-card safe";
            elBeamStatus.innerText = "åˆæ ¼";
            elBeamStatus.style.background = "#d1fae5"; elBeamStatus.style.color = "#065f46";
        } else {
            elBeamCard.className = "res-card danger";
            elBeamStatus.innerText = "ä¸åˆæ ¼";
            elBeamStatus.style.background = "#fee2e2"; elBeamStatus.style.color = "#991b1b";
        }

        // Column
        const elColVal = document.getElementById('val-col-sf');
        const elColCard = document.getElementById('card-col');
        const elColStatus = document.getElementById('status-col');
        
        elColVal.innerText = sf.toFixed(2);
        document.getElementById('val-col-load').innerText = loadLeg.toFixed(0);
        document.getElementById('val-span').innerText = span_m.toFixed(2);

        let colState = 0; // 0:safe, 1:warn, 2:danger
        if(sf < 1.0) {
            colState = 2;
            elColCard.className = "res-card danger";
            elColStatus.innerText = "å±éšª (å€’å¡Œ)";
            elColStatus.style.background = "#fee2e2"; elColStatus.style.color = "#991b1b";
        } else if (sf < 2.0) {
            colState = 1;
            elColCard.className = "res-card warning";
            elColStatus.innerText = "çµæ§‹ä¸ç©©";
            elColStatus.style.background = "#fef3c7"; elColStatus.style.color = "#92400e";
        } else {
            elColCard.className = "res-card safe";
            elColStatus.innerText = "å®‰å…¨";
            elColStatus.style.background = "#d1fae5"; elColStatus.style.color = "#065f46";
        }

        // --- 5. ç¹ªåœ– ---
        drawSystem(hTotal, span_m, layers, deltaBeam, limitBeam, colState, sf);
    }

    function drawSystem(H_m, span_m, layers, beamDef, beamLimit, colState, sf) {
        const cvs = document.getElementById('mainCanvas');
        const ctx = cvs.getContext('2d');
        const W = cvs.width; const H = cvs.height;
        ctx.clearRect(0,0,W,H);

        const marginY = 60;
        const drawH = H - marginY*2;
        const scale = drawH / H_m; // pixels per meter
        
        // åœ°é¢
        ctx.beginPath();
        ctx.moveTo(100, H-marginY); ctx.lineTo(W-100, H-marginY);
        ctx.strokeStyle="#7f8c8d"; ctx.lineWidth=4; ctx.stroke();

        const leftX = W*0.35;
        const rightX = W*0.65;
        
        // --- ç¹ªè£½ç«‹æŸ± ---
        // è¨ˆç®—ç«‹æŸ±è®Šå½¢ (æŒ«å±ˆæ¨¡æ“¬)
        // ä½¿ç”¨ç‡ ratio
        let ratio = 1 / sf; 
        if(ratio > 1.2) ratio = 1.2; // é™åˆ¶æœ€å¤§è®Šå½¢
        let colAmp = Math.pow(ratio, 2) * 30; // åƒç´ 
        
        let colColor = "#2ecc71";
        if(colState === 1) colColor = "#f1c40f";
        if(colState === 2) colColor = "#e74c3c";

        ctx.strokeStyle = colColor; ctx.lineWidth = 8; ctx.lineCap = "round";
        
        const drawCol = (bx, dir) => {
            ctx.beginPath();
            for(let i=0; i<=100; i++) {
                let h_curr = (i/100)*H_m;
                let y = (H-marginY) - (h_curr * scale); // åº§æ¨™è½‰æ›: 0åœ¨ä¸‹
                // æŒ«å±ˆæ³¢å½¢
                let phase = (h_curr / span_m) * Math.PI;
                let wave = Math.sin(phase);
                // æ–¹å‘: æ‹¬è™Ÿå½¢ ()
                let off = wave * colAmp * dir; 
                if(i===0) ctx.moveTo(bx+off, y); else ctx.lineTo(bx+off, y);
            }
            ctx.stroke();
        };
        drawCol(leftX, -1);
        drawCol(rightX, 1);

        // --- ç¹ªè£½æ©«æ¨‘ ---
        // æ©«æ¨‘ä½ç½®: i * span (å‡è¨­ç¬¬ä¸€å±¤æ˜¯ 1*span, æœ€å¾Œä¸€å±¤æ˜¯ layers*span)
        // æ³¨æ„: è®Šå½¢é‡éœ€èª‡å¤§
        let beamVisualDef = (beamDef / beamLimit) * 15; // è‹¥é”ä¸Šé™å‰‡å½ 15px
        if(beamVisualDef > 25) beamVisualDef = 25;
        if(beamVisualDef < 0) beamVisualDef = 0;

        let beamColor = (beamDef > beamLimit) ? "#e74c3c" : "#3498db";

        ctx.strokeStyle = beamColor; ctx.lineWidth = 6;
        ctx.fillStyle = "#2980b9"; // Joint color

        for(let i=1; i<=layers; i++) {
            let h_pos = i * span_m;
            let y_base = (H-marginY) - (h_pos * scale);
            
            if(y_base < marginY) break;

            // ç•«æ›²ç·šæ©«æ¨‘
            ctx.beginPath();
            ctx.moveTo(leftX + 4, y_base);
            // è²èŒ²æ›²ç·šæ¨¡æ“¬ä¸‹å‚
            ctx.quadraticCurveTo((leftX+rightX)/2, y_base + beamVisualDef, rightX - 4, y_base);
            ctx.stroke();

            // ç•«ç¯€é»
            ctx.beginPath(); ctx.arc(leftX, y_base, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(rightX, y_base, 5, 0, Math.PI*2); ctx.fill();
            
            // æ–‡å­—æ¨™ç¤º
            ctx.fillStyle = "#999"; ctx.font="12px Arial"; ctx.textAlign="right";
            if(i===1) ctx.fillText(`1F (${span_m.toFixed(1)}m)`, leftX-15, y_base+4);
            ctx.fillStyle = "#2980b9"; // reset
        }
        
        // æ¨™è¨»å°ºå¯¸
        ctx.fillStyle = "#555"; ctx.font="14px Arial"; ctx.textAlign="center";
        ctx.fillText(`${H_m}m`, leftX - 40, (H/2));
        
        // ç•«å°ºå¯¸ç·š
        ctx.beginPath(); ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
        ctx.moveTo(leftX - 30, H-marginY); ctx.lineTo(leftX-30, marginY);
        ctx.stroke();
    }
</script>

</body>
</html>